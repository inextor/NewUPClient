<div class="container mt-5">
	<h2 class="app-page-title">Crear Orden Manual Multi-Usuario</h2>

	<!-- Step 1: Role Selection -->
	<div class="card bg-white p-3 mb-3">
		<h5>1. Seleccionar Rol</h5>
		<div class="mb-3">
			<label for="roleSelect" class="form-label">Rol</label>
			<select
				class="form-control"
				id="roleSelect"
				[(ngModel)]="selectedRoleId"
				(change)="onRoleSelected()">
				<option [value]="null">-- Seleccione un rol --</option>
				@for (role of roleList; track role.id) {
					<option [value]="role.id">{{ role.name }}</option>
				}
			</select>
			<div class="form-text">
				Seleccione el rol que contiene los usuarios e items para esta orden
			</div>
		</div>

		@if (isLoadingRole) {
			<div class="alert alert-info">
				Cargando datos del rol...
			</div>
		}

		@if (selectedRoleId && !isLoadingRole) {
			<div class="row">
				<div class="col-md-6">
					<div class="alert alert-success">
						<strong>Usuarios:</strong> {{ roleUsers.length }}
					</div>
				</div>
				<div class="col-md-6">
					<div class="alert alert-info">
						<strong>Items Disponibles:</strong> {{ roleEcommerceItems.length }}
					</div>
				</div>
			</div>
		}
	</div>

	<!-- Step 2: Add Rows -->
	@if (selectedRoleId && !isLoadingRole && roleUsers.length > 0 && roleEcommerceItems.length > 0) {
		<div class="card bg-white p-3 mb-3">
			<h5>2. Agregar Items y Usuarios</h5>

			<!-- Add Row Form -->
			<div class="row g-3 mb-3">
				<div class="col-md-4">
					<label class="form-label">Item</label>
					<input
						type="text"
						class="form-control mb-2"
						placeholder="Buscar item..."
						[(ngModel)]="itemSearchTerm"
						(input)="onItemSearchChange()">
					<select
						class="form-control"
						[(ngModel)]="selectedItemId"
						size="5">
						<option [value]="null">-- Seleccione un item --</option>
						@for (item of filteredItems; track item.id) {
							<option [value]="item.id">{{ item.code }} - {{ item.name }}</option>
						}
					</select>
				</div>

				<div class="col-md-4">
					<label class="form-label">Usuario</label>
					<input
						type="text"
						class="form-control mb-2"
						placeholder="Buscar usuario..."
						[(ngModel)]="userSearchTerm"
						(input)="onUserSearchChange()">
					<select
						class="form-control"
						[(ngModel)]="selectedUserId"
						size="5">
						<option [value]="null">-- Seleccione un usuario --</option>
						@for (user of filteredUsers; track user.id) {
							<option [value]="user.id">{{ user.code }} - {{ user.name }}</option>
						}
					</select>
				</div>

				<div class="col-md-4">
					<label class="form-label">Cantidad</label>
					<input
						type="number"
						class="form-control mb-2"
						min="1"
						step="1"
						[(ngModel)]="newRowQty">

					<label class="form-label">Notas (Opcional)</label>
					<input
						type="text"
						class="form-control mb-2"
						placeholder="Notas..."
						[(ngModel)]="newRowNotes">

					<button
						class="btn btn-primary w-100"
						(click)="addRow()">
						+ Agregar Fila
					</button>
				</div>
			</div>

			<!-- Order Rows Table -->
			@if (orderRows.length > 0) {
				<h6 class="mt-4">Filas Agregadas ({{ orderRows.length }})</h6>
				<div class="table-responsive">
					<table class="table table-striped table-hover">
						<thead class="table-light">
							<tr>
								<th>Item</th>
								<th>Usuario</th>
								<th class="text-end">Cantidad</th>
								<th>Notas</th>
								<th class="text-center">Acciones</th>
							</tr>
						</thead>
						<tbody>
							@for (row of orderRows; track row.id; let i = $index) {
								<tr>
									<td>
										<strong>{{ row.ecommerce_item.code }}</strong><br>
										<small class="text-muted">{{ row.ecommerce_item.name }}</small>
									</td>
									<td>
										<strong>{{ row.user.code }}</strong><br>
										<small class="text-muted">{{ row.user.name }}</small>
									</td>
									<td class="text-end">{{ row.qty }}</td>
									<td>
										<small>{{ row.notes || '-' }}</small>
									</td>
									<td class="text-center">
										<button
											class="btn btn-sm btn-danger"
											(click)="removeRow(i)"
											title="Eliminar fila">
											üóëÔ∏è
										</button>
									</td>
								</tr>
							}
						</tbody>
					</table>
				</div>
			} @else {
				<div class="alert alert-info mt-3">
					No hay filas agregadas. Complete el formulario arriba y haga clic en "Agregar Fila".
				</div>
			}
		</div>

		<!-- Step 3: Summary -->
		@if (orderRows.length > 0) {
			<div class="card bg-white p-3 mb-3">
				<h5>3. Resumen</h5>

				<div class="row">
					<!-- Summary by Item -->
					<div class="col-md-6">
						<h6>Resumen por Item</h6>
						<table class="table table-sm table-bordered">
							<thead class="table-light">
								<tr>
									<th>Item</th>
									<th class="text-end">Cantidad Total</th>
								</tr>
							</thead>
							<tbody>
								@for (summary of itemSummaries; track summary.ecommerce_item_id) {
									<tr>
										<td>
											<strong>{{ summary.ecommerce_item?.code }}</strong><br>
											<small class="text-muted">{{ summary.ecommerce_item?.name }}</small>
										</td>
										<td class="text-end"><strong>{{ summary.totalQty }}</strong></td>
									</tr>
								}
							</tbody>
						</table>
					</div>

					<!-- Summary by User -->
					<div class="col-md-6">
						<h6>Resumen por Usuario</h6>
						<table class="table table-sm table-bordered">
							<thead class="table-light">
								<tr>
									<th>Usuario</th>
									<th class="text-end">Cantidad Total</th>
								</tr>
							</thead>
							<tbody>
								@for (summary of userSummaries; track summary.user_id) {
									<tr>
										<td>
											<strong>{{ summary.user.code }}</strong><br>
											<small class="text-muted">{{ summary.user.name }}</small>
										</td>
										<td class="text-end"><strong>{{ summary.totalQty }}</strong></td>
									</tr>
								}
							</tbody>
						</table>
					</div>
				</div>
			</div>

			<!-- Step 4: Order Notes and Save -->
			<div class="card bg-white p-3 mb-3">
				<h5>4. Notas y Guardar</h5>
				<div class="mb-3">
					<label for="orderNotes" class="form-label">Notas de la Orden (Opcional)</label>
					<textarea
						class="form-control"
						id="orderNotes"
						rows="3"
						[(ngModel)]="orderNotes"
						placeholder="Agregue notas adicionales para esta orden..."></textarea>
				</div>

				<button
					class="btn btn-success btn-lg"
					[disabled]="!canSave()"
					(click)="saveOrder()">
					Guardar Orden
				</button>
				<div class="form-text mt-2">
					Esta acci√≥n crear√° la orden con todos sus items y asignaciones de usuarios.
				</div>
			</div>
		}
	}

	@if (selectedRoleId && !isLoadingRole && (roleUsers.length === 0 || roleEcommerceItems.length === 0)) {
		<div class="alert alert-warning">
			<strong>Atenci√≥n:</strong> El rol seleccionado no tiene
			@if (roleUsers.length === 0) {
				usuarios asignados.
			}
			@if (roleEcommerceItems.length === 0) {
				items asignados.
			}
			Por favor, seleccione otro rol o asigne usuarios/items al rol seleccionado.
		</div>
	}
</div>
